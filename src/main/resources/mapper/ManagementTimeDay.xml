<?xml version = "1.0" encoding = "UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shsoftvina.erpshsoftvina.mapper.ManagementTimeDayMapper">

    <select id="findByListDay" resultMap="dayResultMap">
        SELECT *
        FROM MANAGEMENT_TIME_DAY m
        INNER JOIN USER u ON m.USER_ID = u.ID
        WHERE m.USER_ID = #{userId} AND m.DAY IN
        <foreach item="day" collection="days" open="(" separator="," close=")">
            #{day}
        </foreach>
    </select>

    <insert id="createListCalendarDay" parameterType="java.util.List" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO MANAGEMENT_TIME_DAY (ID, ONE_THING_CALENDAR, DAY, USER_ID, WEEKLY_CODE)
        VALUES
        <foreach collection="days" item="day" separator=",">
            (UUID(), #{day.oneThingCalendar}, #{day.day}, #{day.user.id}, #{day.weeklyCode})
        </foreach>
    </insert>

    <update id="editListCalendarDay" parameterType="java.util.List">
        <foreach collection="days" item="day" separator=";">
            UPDATE MANAGEMENT_TIME_DAY
            SET ONE_THING_CALENDAR = #{day.oneThingCalendar}
            WHERE ID = #{day.id}
        </foreach>
    </update>

    <update id="updateOneThingCalendarNull" parameterType="java.util.Map">
        UPDATE MANAGEMENT_TIME_DAY
        SET ONE_THING_CALENDAR = null
        WHERE USER_ID = #{userId}
        AND DAY NOT IN
        <foreach item="day" collection="days" open="(" separator="," close=")">
            #{day}
        </foreach>
    </update>

    <update id="updateOneThingCalendarAllDayNull" parameterType="java.util.Map">
        UPDATE MANAGEMENT_TIME_DAY
        SET ONE_THING_CALENDAR = null
        WHERE USER_ID = #{userId}
        AND DAY IN
        <foreach item="day" collection="days" open="(" separator="," close=")">
            #{day}
        </foreach>
    </update>

    <select id="findAllDailyRoutineOfMonth" resultMap="dayResultMap">
        SELECT m.DAILY_ROUTINE FROM MANAGEMENT_TIME_DAY m
                                        INNER JOIN MONTHLY_MANAGEMENT_TIME_DAY mo ON DATE_FORMAT(m.DAY, '%Y-%m') = mo.CODE
                                        INNER JOIN USER u ON m.USER_ID = u.ID
        WHERE m.USER_ID = #{userId} AND mo.CODE = #{monthlyCode} AND mo.USER_ID = #{userId}
    </select>








    <select id="findByDay" resultMap="dayResultMap">
        SELECT *
        FROM MANAGEMENT_TIME_DAY m
        INNER JOIN USER u ON m.USER_ID = u.ID
        WHERE m.USER_ID = #{userId} AND m.DAY = #{day, jdbcType=DATE}
    </select>

    <resultMap id="dayResultMap" type="com.shsoftvina.erpshsoftvina.entity.ManagementTimeDay">
        <id property="id" column="ID"/>
        <result property="oneThingCalendar" column="ONE_THING_CALENDAR"/>
        <result property="toDoList" column="TO_DO_LIST"/>
        <result property="gratitudeDiary" column="GRATITUDE_DIARY"/>
        <result property="affirmation" column="AFFIRMATION"/>
        <result property="complimentForMeToday" column="COMPLIMENT_FOR_ME_TODAY"/>
        <result property="todaysReflectionsAndImprovements" column="TODAYS_REFLECTIONS_AND_IMPROVEMENTS"/>
        <result property="toDoDetail" column="TODO_DETAIL"/>
        <result property="dailyRoutine" column="DAILY_ROUTINE"/>
        <result property="day" column="DAY"/>
        <result property="weeklyCode" column="WEEKLY_CODE"/>
        <association property="user" column="USER_ID" javaType="com.shsoftvina.erpshsoftvina.entity.User" resultMap="userResultMap">
        </association>
    </resultMap>

    <resultMap id="userResultMap" type="com.shsoftvina.erpshsoftvina.entity.User">
        <id property="id" column="USER_ID" />
        <result property="fullname" column="FULLNAME" />
    </resultMap>

    <insert id="createCalendarDay" parameterType="com.shsoftvina.erpshsoftvina.entity.ManagementTimeDay">
        INSERT INTO MANAGEMENT_TIME_DAY (ID, ONE_THING_CALENDAR, DAY, USER_ID, WEEKLY_CODE)
        VALUES (UUID(), #{oneThingCalendar}, #{day}, #{user.id}, #{weeklyCode})
    </insert>

    <update id="updateCalendarDay" parameterType="com.shsoftvina.erpshsoftvina.entity.ManagementTimeDay">
        UPDATE MANAGEMENT_TIME_DAY
        SET ONE_THING_CALENDAR = #{oneThingCalendar}
        WHERE USER_ID = #{user.id} AND DAY = #{day, jdbcType=DATE}
    </update>

    <select id="findByCode" resultMap="dayResultMap">
        SELECT *
        FROM MANAGEMENT_TIME_DAY m
        INNER JOIN USER u ON m.USER_ID = u.ID
        WHERE m.USER_ID = #{userId} AND m.WEEKLY_CODE = #{weeklyCode}
    </select>

    <insert id="insertDay" parameterType="com.shsoftvina.erpshsoftvina.entity.ManagementTimeDay" >
        INSERT INTO MANAGEMENT_TIME_DAY (ID, ONE_THING_CALENDAR, TO_DO_LIST, GRATITUDE_DIARY, AFFIRMATION, DAY, USER_ID, WEEKLY_CODE,
            COMPLIMENT_FOR_ME_TODAY, TODAYS_REFLECTIONS_AND_IMPROVEMENTS, TODO_DETAIL, DAILY_ROUTINE)
        VALUES (UUID(), #{oneThingCalendar}, #{toDoList}, #{gratitudeDiary}, #{affirmation}, #{day}, #{user.id}, #{weeklyCode},
             #{complimentForMeToday}, #{todaysReflectionsAndImprovements}, #{toDoDetail}, #{dailyRoutine})
    </insert>

    <update id="editDay" parameterType="com.shsoftvina.erpshsoftvina.entity.ManagementTimeDay">
        UPDATE MANAGEMENT_TIME_DAY
        SET ONE_THING_CALENDAR = #{oneThingCalendar},
            TO_DO_LIST = #{toDoList},
            GRATITUDE_DIARY = #{gratitudeDiary},
            AFFIRMATION = #{affirmation},
            COMPLIMENT_FOR_ME_TODAY = #{complimentForMeToday},
            TODAYS_REFLECTIONS_AND_IMPROVEMENTS = #{todaysReflectionsAndImprovements},
            TODO_DETAIL = #{toDoDetail},
            DAILY_ROUTINE = #{dailyRoutine}
        WHERE ID = #{id}
    </update>



    <select id="findByListCode" resultMap="dayResultMap">
        SELECT *
        FROM MANAGEMENT_TIME_DAY m
        INNER JOIN USER u ON m.USER_ID = u.ID
        WHERE m.USER_ID = #{userId} AND m.WEEKLY_CODE IN
        <foreach item="code" collection="codes" open="(" separator="," close=")">
            #{code}
        </foreach>
    </select>
</mapper>